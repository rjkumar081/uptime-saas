name: Deploy to Railway (manual, pinned service)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: uptime-backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo files (debug)
        run: |
          echo "=== repo root listing ==="
          ls -la
          echo "=== uptime-backend listing ==="
          ls -la uptime-backend || true

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "ERROR: RAILWAY_TOKEN missing"
            exit 1
          fi
          if [ -z "${{ secrets.RAILWAY_PROJECT }}" ]; then
            echo "WARNING: RAILWAY_PROJECT not set (recommended)."
          fi
          if [ -z "${{ secrets.RAILWAY_SERVICE }}" ]; then
            echo "ERROR: RAILWAY_SERVICE missing - set service id in secrets"
            exit 1
          fi
          echo "Secrets present (masked)."

      - name: Debug: whoami (validate token)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "=== railway whoami ==="
          RAILWAY_TOKEN="$RAILWAY_TOKEN" npx @railway/cli whoami --verbose || true
          echo "=== end whoami ==="

      - name: Deploy to Railway (explicit project & service)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          set -euo pipefail
          echo "Starting railway up (explicit project + service)..."
          export RAILWAY_TOKEN="$RAILWAY_TOKEN"

          # prefer explicit project id if provided
          if [ -n "${{ secrets.RAILWAY_PROJECT }}" ]; then
            echo "Using project: (masked)"
            PROJECT_ARG="--project \"${{ secrets.RAILWAY_PROJECT }}\""
          else
            PROJECT_ARG=""
          fi

          # always use service id (must be provided)
          SERVICE_ID="${{ secrets.RAILWAY_SERVICE }}"

          echo "Running: npx @railway/cli up --ci --service \"$SERVICE_ID\" $PROJECT_ARG --verbose"
          # shell-expand safely
          eval npx @railway/cli up --ci --service \"$SERVICE_ID\" $PROJECT_ARG --verbose || {
            echo "railway up failed with exit code $?"
            npx @railway/cli --version || true
            exit 1
          }

      - name: Done
        run: echo "Deploy workflow finished."
