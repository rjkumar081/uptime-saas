name: Backend CI / Deploy to Render

on:
  push:
    branches:
      - main
      - master
      - 'release/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: uptime-backend

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm install

    - name: Run lint (optional)
      run: npm run lint || echo "no lint script"

    - name: Run tests (optional)
      run: npm test || echo "no tests"

    - name: Build (if you have build step)
      run: echo "no build step for backend"

    - name: Trigger Render deploy
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        echo "Triggering deploy on Render for service $RENDER_SERVICE_ID"
        curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"clearCache\": false}" \
          | jq .

    - name: Wait for Render deploy (poll)
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        DEPLOY_ID=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID" | jq -r '.latestDeploy.id')
        echo "Latest deploy id: $DEPLOY_ID"
        for i in {1..60}; do
          STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID" | jq -r '.status')
          echo "Deploy status: $STATUS"
          if [[ "$STATUS" == "active" || "$STATUS" == "failed" ]]; then
            break
          fi
          sleep 10
        done
        if [[ "$STATUS" == "failed" ]]; then
          echo "Render deploy failed"
          exit 1
        fi
        echo "Render deploy finished with status: $STATUS"
