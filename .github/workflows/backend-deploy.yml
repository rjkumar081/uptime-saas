name: Backend CI / Deploy to Railway

# Trigger on pushes to main/master or release branches; also manual dispatch
on:
  push:
    branches:
      - main
      - master
      - 'release/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: uptime-backend

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci

    - name: Run lint (optional)
      run: npm run lint || echo "no lint script"

    - name: Run tests (optional)
      run: npm test || echo "no tests"

    - name: Build (if needed)
      run: echo "no build step for backend"

    - name: Show reference screenshot path (for debugging)
      run: echo "Reference screenshot (local): /mnt/data/9aeddbed-fb7f-4624-9918-61377a3e437f.png"

    # Install Railway CLI
    - name: Install Railway CLI
      run: |
        set -e
        echo "Installing Railway CLI..."
        curl -fsSL https://railway.app/install.sh | sh
        echo "railway version:"
        railway --version || true

    # Deploy: non-interactive CI mode (uses RAILWAY_TOKEN secret)
    - name: Deploy to Railway (CI mode - non-interactive)
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      run: |
        set -e
        echo "Starting Railway deploy (CI mode)..."

        if [ -z "$RAILWAY_TOKEN" ]; then
          echo "ERROR: RAILWAY_TOKEN secret is missing. Add it in GitHub repo secrets."
          exit 1
        fi

        # Export token so CLI reads it from env
        export RAILWAY_TOKEN="$RAILWAY_TOKEN"

        # Try the installed railway binary first (some installs place binary at /usr/local/bin/railway)
        if command -v railway >/dev/null 2>&1 ; then
          echo "Using railway binary"
          # --ci makes it non-interactive and uses RAILWAY_TOKEN for auth
          railway up --ci --verbose || {
            echo "railway up failed; falling back to npx @railway/cli"
            npx @railway/cli up --ci --verbose
          }
        else
          echo "railway binary not found; using npx @railway/cli"
          npx @railway/cli up --ci --verbose
        fi

        echo "Railway deploy command finished."

    - name: Done
      run: echo "Workflow finished."
